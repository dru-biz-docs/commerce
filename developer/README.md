# Developer

## Описание функционала.

### CmlAPI  https://www.drupal.org/project/cmlapi

Вы можете вручную создать сущность обмена, прикрепить к ней файлы `import.xml` и `offers.xml` и получить весь функционал ниже. Для автоматического создания смотри `Cml Exchange` ниже.

* Сущность "обмен" `cml`: 
  - `uuid` = `cookies` обмена для 1С
  - `state` - статус обмена  [zip|new|progress|success|busy|failure]
  - `type` - тип обмена [catalog|sale]
  - `field_file` - переданные во время обмена файлы, кроме картинок
  - `login`, `ip`, `created`,	`changed` - параметры обмена
* Работа с сущностью
  - views со списком сущностей `/admin/structure/cml`
  - просмотрщик каталога `/admin/structure/cml/{ID}/catalog` и другой таксономии
  - просмотрщик товаров `/admin/structure/cml/{ID}/product`
  - просмотрщик вариаций `/admin/structure/cml/{ID}/product-variaton`
* Крон и сервис `cmlapi.cleaner`:
  - удаление пустых обменов (которые не содежрат файлы)
  - удаление старых обменов (старше чем хх)
* Сервис доступа к обмену `cmlapi.cml`
  - текущий обмен
  - актуальный обмен
  - выстраивание очереди обменов [?] может стоит перенести в модуль cmlexchange
* Парсер-сервисы
  - `cmlapi.xml_parser` - разбор XML
  - `cmlapi.parser_catalog` - вытащить из XML-объекта каталоги и другую таксономию
  - `cmlapi.parser_product` - вытащить из XML-объекта товары в соответсвии с мапингом
  - `cmlapi.parser_offers` - вытащить из XML-объекта оферы в соответствии с мапингом
  - на выходе:
    * Можно получить все необходимые поля, если разобраться с мапингом
    * Русские ключи пишутся латиницей в соответствии с правилами транслитерации
    * Результаты парсинга закэшированы чанками по 300 элементов
* Настройка мапинга для `parser_product` и `parser_offers`
  - описание:
    - для получения данных из `xml` задаётся с помощю `yml`
    - стандартный мапинг задаётся при установке, поля `Product Standart` и `Offers Standart`
    - дополнительный мапинг задавай сам: в настройках `Product Dop` `Offers Dop`
    - при парсинге `Standart` и `Dop` мапинг складываются
  - мапинг-параметры: `Drupal\cmlapi\Service::prepare($data, $key, $map)`
    - **default** или {type: 'string'} - получение строчки, `Drupal\cmlapi\Service::prepareString()`
    - {type: []} - получение массива, `Drupal\cmlapi\Service::prepareArray()`
    - {type: 'attr'} - получение атрибута, `Drupal\cmlapi\Service::prepareAttribute()`
    - {type: 'keyval'} - данные ключ-значение, `Drupal\cmlapi\Service::prepareKeyVal()`
    - {skip: 1} - выключение парсера (то-же самое что удалить строчку)
* TODO:
  - доразобраться с задачами крона, и вынести их в настройки
  - удалять xml-файлы и директории вместе с удалением обменов
  - либо парсеры сделать плагинами и форму-настройку для выбора нужного плагина, либо сделать инструкцию по кастомизации сервисов
  - доактуализировать историю с кэшами

#### Стандартный мапинг `parser_product`
```yml
Ид:
Артикул:
Штрихкод:
Наименование:
ПометкаУдаления:
БазоваяЕдиница: {type: 'attr', skip: 1, attr: 'НаименованиеПолное'}
Группы: {type: []}
Категория:
Описание:
Картинка:
Изготовитель: {type: 'keyval'}
СтавкиНалогов: {type: 'keyval', skip: 1}
ЗначенияСвойств: {type: 'keyval'}
ЗначенияРеквизитов: {type: 'keyval'}
```
#### Стандартный мапинг `parser_offers`
```yml
Ид:
Наименование:
БазоваяЕдиница: {type: 'attr', skip: 1, attr: 'НаименованиеПолное'}
Количество:
Склад: {type: 'attr', attr: 'КоличествоНаСкладе'}
Цены: {type: []}
```

### Cml Exchange
Обмен файлами с 1С https://www.drupal.org/project/cmlexchange
* Создаёт сущности `cml` для хранения CommerceML `import.xml` и `offers.xml` 
* Сохраняет переданные картинки в `public://cml/import_files` и создаёт file-сущности
* Реализует `pipeline` для прохождения обмена
* Отдаёт информацию о заказах в 1С
* TODO/неTODO: обновляет заказы на основании полученных данных
#### Возможности
* Реализация протокола
  - Описание протокола тут http://v8.1c.ru/edi/edi_stnd/131/
  - Протокол обмена - это передача файлов, в модуле нет ничего про форматы XML
  - `/cmlexchange` -  адрес для 1С для обмена
  - TODO разделить на уровне адреса полноту данных `/cmlexchange/full` и `/cmlexchange/incremental`
* Сохранение файлов
* Форма на странице обмена (сущность `cml`)
  - Импортировать
  - Продолжить
* Данные о заказах
* Запуск миграций
  - в настройках можно определить запукать или нет миграции на последнем шаге обмена
  - для запуска миграции данных нужен модуль `Cml Migrations` ниже
* PipeLine
* TODO:
  - Basic Auth модуля конфликтует с `REST+BasicAuth`

### Cml Migrations

Импорт 1С-файлов https://www.drupal.org/project/cmlmigrations
*
*
